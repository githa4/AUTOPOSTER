
-- 1. Создание Bucket (Ведра) для хранения картинок
-- Мы создаем публичное ведро, чтобы Telegram мог скачивать картинки по URL.
INSERT INTO storage.buckets (id, name, public)
VALUES ('post_images', 'post_images', true)
ON CONFLICT (id) DO NOTHING;

-- 2. Настройка Политик Безопасности (RLS)

-- Разрешить публичный просмотр (SELECT) для всех
-- Это нужно, чтобы в приложении и в Telegram картинки отображались.
CREATE POLICY "Public Access"
ON storage.objects FOR SELECT
USING ( bucket_id = 'post_images' );

-- Разрешить загрузку (INSERT) только авторизованным пользователям
-- Важно: Мы проверяем, что пользователь загружает файл в папку со своим ID.
-- Структура пути: user_id/filename.png
CREATE POLICY "Authenticated users can upload"
ON storage.objects FOR INSERT
WITH CHECK (
    bucket_id = 'post_images'
    AND auth.role() = 'authenticated'
    AND (storage.foldername(name))[1] = auth.uid()::text
);

-- Разрешить удаление (DELETE) только владельцам файлов
CREATE POLICY "Users can delete own images"
ON storage.objects FOR DELETE
USING (
    bucket_id = 'post_images'
    AND auth.role() = 'authenticated'
    AND (storage.foldername(name))[1] = auth.uid()::text
);

-- Разрешить обновление (UPDATE) только владельцам
CREATE POLICY "Users can update own images"
ON storage.objects FOR UPDATE
USING (
    bucket_id = 'post_images'
    AND auth.role() = 'authenticated'
    AND (storage.foldername(name))[1] = auth.uid()::text
);
